# üè™ Sistema Multi-Tenant de Tiendas - Documentaci√≥n Completa

## üìã √çndice

1. [Resumen del Sistema](#resumen-del-sistema)
2. [Arquitectura](#arquitectura)
3. [Estructura de Datos](#estructura-de-datos)
4. [Flujos de Usuario](#flujos-de-usuario)
5. [API y Funciones](#api-y-funciones)
6. [Configuraci√≥n](#configuraci√≥n)
7. [Despliegue](#despliegue)
8. [Mantenimiento](#mantenimiento)

---

## üéØ Resumen del Sistema

### ¬øQu√© es?
Sistema SaaS multi-tenant que permite a los usuarios crear y gestionar m√∫ltiples tiendas online con URLs personalizadas.

### Caracter√≠sticas principales
- ‚úÖ **URLs personalizadas**: `tu-dominio.com/nombre-tienda`
- ‚úÖ **M√∫ltiples tiendas por usuario**: Un email puede tener varias tiendas
- ‚úÖ **Registro por invitaci√≥n**: Links √∫nicos que expiran
- ‚úÖ **Google Auth**: Autenticaci√≥n compartida con ControlFile
- ‚úÖ **Panel admin por tienda**: Gesti√≥n individual de cada tienda
- ‚úÖ **Integraci√≥n ControlFile**: Carpetas en taskbar
- ‚úÖ **Firestore compartido**: Estructura organizada en `apps/control-store/`

---

## üèóÔ∏è Arquitectura

### Estructura de Rutas
```
/                           ‚Üí Landing page
/admin                      ‚Üí Login admin principal
/admin/dashboard            ‚Üí Panel admin (generar links)
/admin/signup/[token]       ‚Üí Registro con link √∫nico
/[storeSlug]                ‚Üí Tienda p√∫blica
/[storeSlug]/carrito        ‚Üí Carrito de la tienda
/[storeSlug]/checkout       ‚Üí Checkout de la tienda
/[storeSlug]/pedido-enviado ‚Üí Confirmaci√≥n de pedido
/[storeSlug]/admin          ‚Üí Panel admin de la tienda (PENDIENTE)
```

### Tecnolog√≠as
- **Frontend**: Next.js 14, React 19, TypeScript
- **UI**: TailwindCSS, Shadcn/ui
- **Estado**: Zustand
- **Base de datos**: Firestore (compartido con ControlFile)
- **Auth**: Firebase Auth (compartido)
- **Deploy**: Vercel

---

## üóÇÔ∏è Estructura de Datos

### Firestore (Compartido con ControlFile)
```
apps/
‚îî‚îÄ‚îÄ control-store/
    ‚îú‚îÄ‚îÄ users/              # Usuarios del sistema
    ‚îÇ   ‚îî‚îÄ‚îÄ {userId}/
    ‚îú‚îÄ‚îÄ stores/             # Tiendas
    ‚îÇ   ‚îî‚îÄ‚îÄ {storeId}/
    ‚îÇ       ‚îî‚îÄ‚îÄ products/   # Productos por tienda
    ‚îÇ           ‚îî‚îÄ‚îÄ {productId}/
    ‚îî‚îÄ‚îÄ invitations/        # Links de invitaci√≥n
        ‚îî‚îÄ‚îÄ {invitationId}/

files/                      # Colecci√≥n compartida (ControlFile)
‚îî‚îÄ‚îÄ {fileId}/              # Carpetas de tiendas en taskbar
```

### Colecciones Detalladas

#### `apps/control-store/users`
```typescript
{
  id: "firebase-user-id",
  email: "juan@gmail.com",
  displayName: "Juan P√©rez",
  stores: ["store_1", "store_2", "store_3"], // Array de IDs de tiendas
  createdAt: Timestamp,
  updatedAt: Timestamp
}
```

#### `apps/control-store/stores`
```typescript
{
  id: "store_abc123",
  slug: "pizzas-don-juan",        // URL: /pizzas-don-juan
  name: "Pizzas Don Juan",
  ownerEmail: "juan@gmail.com",
  ownerId: "firebase-user-id",
  config: {
    name: "Pizzas Don Juan",
    phone: "+54 9 2944 99-7155",
    address: "Calle 123, Buenos Aires",
    deliveryFee: 500,
    minOrderAmount: 2000,
    openingHours: "Lun-Dom 11:00 - 23:00"
  },
  createdAt: Timestamp,
  updatedAt: Timestamp
}
```

#### `apps/control-store/stores/{storeId}/products`
```typescript
{
  id: "prod_123",
  name: "Pizza Muzzarella",
  description: "Cl√°sica pizza con muzzarella",
  basePrice: 4500,
  image: "/placeholder.svg",
  category: "pizzas",
  section: "destacados",
  variants: [
    { id: "peque√±a", name: "Peque√±a", price: 4500 },
    { id: "mediana", name: "Mediana", price: 6000 }
  ],
  complements: [
    { id: "aceitunas", name: "Aceitunas", price: 300 }
  ],
  available: true,
  featured: true,
  createdAt: Timestamp,
  updatedAt: Timestamp
}
```

#### `apps/control-store/invitations`
```typescript
{
  id: "inv_xyz789",
  token: "link-secreto-123",
  storeName: "Nueva Tienda",
  used: false,
  usedByEmail: null,
  usedById: null,
  expiresAt: Timestamp, // 7 d√≠as
  createdAt: Timestamp
}
```

#### `files` (ControlFile compartido)
```typescript
{
  id: "store-abc123-main",
  userId: "firebase-user-id",
  name: "Pizzas Don Juan",
  type: "folder",
  parentId: null,
  metadata: {
    source: "taskbar",
    icon: "Taskbar",
    color: "text-blue-600",
    storeId: "abc123"
  }
}
```

---

## üë• Flujos de Usuario

### 1. Flujo de Registro (Link √önico)

```mermaid
graph TD
    A[Admin genera link] --> B[Env√≠a link a cliente]
    B --> C[Cliente abre link]
    C --> D{¬øAutenticado?}
    D -->|No| E[Login con Google]
    D -->|S√≠| F[Continuar]
    E --> F
    F --> G[Crear/actualizar usuario]
    G --> H[Crear tienda con slug]
    H --> I[Asociar tienda al usuario]
    I --> J[Crear carpeta en ControlFile]
    J --> K[Redirigir a /mi-tienda]
```

**Pasos detallados:**
1. Admin va a `/admin/dashboard`
2. Tab "Invitaciones" ‚Üí Ingresa nombre ‚Üí Genera link
3. Copia y env√≠a link: `tu-dominio.com/admin/signup/abc123`
4. Cliente abre link ‚Üí Login con Google
5. Sistema crea/actualiza documento en `users`
6. Cliente ingresa nombre de tienda ‚Üí Sistema genera slug
7. Se crea tienda en `stores`
8. Se asocia tienda al usuario en `users.stores[]`
9. Se crea carpeta en ControlFile taskbar
10. Redirecci√≥n a `tu-dominio.com/mi-tienda`

### 2. Flujo de Tienda P√∫blica

```mermaid
graph TD
    A[Usuario visita /mi-tienda] --> B[Cargar datos de tienda]
    B --> C[Mostrar productos]
    C --> D[Usuario agrega al carrito]
    D --> E[Ir a /mi-tienda/carrito]
    E --> F[Ir a /mi-tienda/checkout]
    F --> G[Enviar pedido por WhatsApp]
    G --> H[Confirmaci√≥n en /mi-tienda/pedido-enviado]
```

### 3. Flujo de Admin (Pendiente)

```mermaid
graph TD
    A[Usuario va a /mi-tienda/admin] --> B[Login con Google]
    B --> C{¬øEs owner de la tienda?}
    C -->|S√≠| D[Mostrar panel admin]
    C -->|No| E[Error 403]
    D --> F[Gestionar productos]
    D --> G[Configurar tienda]
    D --> H[Ver estad√≠sticas]
```

---

## üîß API y Funciones

### Gesti√≥n de Usuarios

```typescript
// Crear o actualizar documento de usuario
await ensureUserDocument(userId: string, email: string, displayName?: string)

// Agregar tienda al array de stores del usuario
await addStoreToUser(userId: string, storeId: string)

// Obtener todas las tiendas de un usuario
const stores = await getUserStores(userId: string)

// Verificar si un usuario es owner de una tienda espec√≠fica
const isOwner = await isUserOwnerOfStore(userId: string, storeSlug: string)
```

### Gesti√≥n de Tiendas

```typescript
// Crear tienda
const storeId = await createStore(data: Omit<Store, 'id' | 'createdAt' | 'updatedAt'>)

// Obtener tienda por slug
const store = await getStoreBySlug(slug: string)

// Obtener tienda por ID
const store = await getStoreById(id: string)

// Actualizar configuraci√≥n de tienda
await updateStoreConfig(storeId: string, config: Partial<Store['config']>)

// Verificar disponibilidad de slug
const available = await isSlugAvailable(slug: string)

// Generar slug desde nombre
const slug = generateSlug(name: string)
```

### Gesti√≥n de Invitaciones

```typescript
// Crear link de invitaci√≥n
const token = await createInvitation(storeName: string)

// Obtener invitaci√≥n por token
const invitation = await getInvitationByToken(token: string)

// Marcar invitaci√≥n como usada
await markInvitationAsUsed(token: string, email: string, userId: string)
```

### Tipos TypeScript

```typescript
interface User {
  id: string
  email: string
  displayName: string
  stores: string[] // Array de IDs de tiendas
  createdAt: Date | any
  updatedAt: Date | any
}

interface Store {
  id: string
  slug: string
  name: string
  ownerEmail: string
  ownerId: string
  config: StoreConfig
  createdAt: Date | any
  updatedAt: Date | any
}

interface StoreConfig {
  name: string
  phone: string
  address: string
  deliveryFee: number
  minOrderAmount: number
  openingHours: string
}

interface Invitation {
  id: string
  token: string
  storeName: string
  used: boolean
  usedByEmail?: string
  usedById?: string
  expiresAt: Date | any
  createdAt: Date | any
}
```

---

## ‚öôÔ∏è Configuraci√≥n

### Variables de Entorno

```env
# .env.local
NEXT_PUBLIC_REBASE_API_KEY=tu-api-key
NEXT_PUBLIC_REBASE_AUTH_DOMAIN=tu-proyecto.firebaseapp.com
NEXT_PUBLIC_REBASE_PROJECT_ID=tu-proyecto
NEXT_PUBLIC_REBASE_STORAGE_BUCKET=tu-proyecto.appspot.com
NEXT_PUBLIC_REBASE_MESSAGING_SENDER_ID=123456789
NEXT_PUBLIC_REBASE_APP_ID=tu-app-id
BACKEND_URL=https://controlfile.tu-url.com
```

### Instalaci√≥n

```bash
# Instalar dependencias
pnpm install

# Ejecutar en desarrollo
pnpm dev

# Construir para producci√≥n
pnpm build

# Iniciar en producci√≥n
pnpm start
```

### Dependencias Principales

```json
{
  "firebase": "^12.4.0",
  "react-firebase-hooks": "^5.1.1",
  "next": "^16.0.0",
  "react": "^19.0.0",
  "zustand": "^5.0.8"
}
```

---

## üöÄ Despliegue

### Vercel (Recomendado)

1. **Conectar repositorio** a Vercel
2. **Configurar variables de entorno** en Vercel Dashboard
3. **Deploy autom√°tico** desde main branch

### Variables de Entorno en Vercel

```
NEXT_PUBLIC_REBASE_API_KEY = tu-api-key
NEXT_PUBLIC_REBASE_AUTH_DOMAIN = tu-proyecto.firebaseapp.com
NEXT_PUBLIC_REBASE_PROJECT_ID = tu-proyecto
NEXT_PUBLIC_REBASE_STORAGE_BUCKET = tu-proyecto.appspot.com
NEXT_PUBLIC_REBASE_MESSAGING_SENDER_ID = 123456789
NEXT_PUBLIC_REBASE_APP_ID = tu-app-id
BACKEND_URL = https://controlfile.tu-url.com
```

### Configuraci√≥n de Dominio

- **Producci√≥n**: `tu-dominio.com`
- **Desarrollo**: `localhost:3000`
- **Staging**: `tu-app.vercel.app`

---

## üîß Mantenimiento

### Monitoreo

1. **Logs de Vercel**: Revisar errores en dashboard
2. **Firestore**: Monitorear uso de colecciones
3. **Firebase Auth**: Verificar usuarios activos

### Backup

```bash
# Backup de Firestore (usando Firebase CLI)
firebase firestore:export gs://tu-bucket/backup-$(date +%Y%m%d)

# Backup de Storage (si se usa)
gsutil -m cp -r gs://tu-bucket/storage gs://tu-bucket/backup-storage-$(date +%Y%m%d)
```

### Actualizaciones

1. **Dependencias**: `pnpm update`
2. **Next.js**: Seguir gu√≠a de migraci√≥n
3. **Firebase**: Actualizar SDK cuando sea necesario

### Escalabilidad

- **Firestore**: Escala autom√°ticamente
- **Vercel**: Escala autom√°ticamente
- **Firebase Auth**: Escala autom√°ticamente

---

## üìä M√©tricas y Analytics

### M√©tricas Importantes

1. **Tiendas creadas** por d√≠a/semana
2. **Usuarios activos** por mes
3. **Pedidos procesados** por tienda
4. **Tiempo de carga** de p√°ginas

### Herramientas

- **Vercel Analytics**: M√©tricas de rendimiento
- **Firebase Analytics**: Eventos de usuario
- **Firestore**: Consultas de datos

---

## üõ†Ô∏è Desarrollo

### Estructura de Archivos

```
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ [storeSlug]/           # Rutas din√°micas de tiendas
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ page.tsx           # Tienda p√∫blica
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx         # Layout de tienda
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ carrito/page.tsx   # Carrito
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ checkout/page.tsx  # Checkout
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ pedido-enviado/page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ admin/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ page.tsx           # Login admin
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dashboard/page.tsx # Panel admin
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ signup/[token]/page.tsx
‚îÇ   ‚îî‚îÄ‚îÄ globals.css
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ admin/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ invitation-link-generator.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ product-form.tsx
‚îÇ   ‚îú‚îÄ‚îÄ ui/                    # Componentes base
‚îÇ   ‚îî‚îÄ‚îÄ cart-item-card.tsx
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îú‚îÄ‚îÄ firebase.ts            # Config Firebase
‚îÇ   ‚îú‚îÄ‚îÄ stores.ts              # CRUD de tiendas
‚îÇ   ‚îú‚îÄ‚îÄ types.ts               # Tipos TypeScript
‚îÇ   ‚îî‚îÄ‚îÄ whatsapp.ts            # Integraci√≥n WhatsApp
‚îú‚îÄ‚îÄ middleware.ts               # Validaci√≥n de rutas
‚îî‚îÄ‚îÄ vercel.json                # Config Vercel
```

### Convenciones

- **Rutas**: kebab-case (`/mi-tienda`)
- **Componentes**: PascalCase (`ProductCard`)
- **Funciones**: camelCase (`createStore`)
- **Variables**: camelCase (`storeName`)
- **Tipos**: PascalCase (`Store`, `User`)

---

## üö® Troubleshooting

### Problemas Comunes

1. **Error de autenticaci√≥n**
   - Verificar variables de entorno
   - Revisar configuraci√≥n de Firebase

2. **Tienda no encontrada**
   - Verificar slug en URL
   - Revisar colecci√≥n `stores` en Firestore

3. **Error de permisos**
   - Verificar reglas de Firestore
   - Revisar ownership de tienda

4. **Link de invitaci√≥n no funciona**
   - Verificar expiraci√≥n
   - Revisar si ya fue usado

### Logs √ötiles

```typescript
// En desarrollo
console.log('Store data:', storeData)
console.log('User stores:', userStores)

// En producci√≥n
console.error('Error creating store:', error)
```

---

## üìû Soporte

### Documentaci√≥n Adicional

- [MULTI_TENANT_README.md](./MULTI_TENANT_README.md) - Gu√≠a r√°pida
- [FLUJO_CORREGIDO.md](./FLUJO_CORREGIDO.md) - Cambios realizados
- [CAMBIOS_FIRESTORE_COMPARTIDO.md](./CAMBIOS_FIRESTORE_COMPARTIDO.md) - Estructura compartida

### Contacto

- **Issues**: Crear issue en GitHub
- **Email**: soporte@tu-dominio.com
- **Documentaci√≥n**: [docs.tu-dominio.com](https://docs.tu-dominio.com)

---

## üéâ Conclusi√≥n

Sistema multi-tenant completo y funcional que permite:

- ‚úÖ Crear m√∫ltiples tiendas por usuario
- ‚úÖ URLs personalizadas por tienda
- ‚úÖ Registro por invitaci√≥n √∫nica
- ‚úÖ Integraci√≥n con ControlFile
- ‚úÖ Panel de administraci√≥n
- ‚úÖ Escalabilidad y mantenimiento

**¬°Sistema listo para producci√≥n! üöÄ**

---

*√öltima actualizaci√≥n: $(date)*
